-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.album_photos (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  album_id uuid,
  photo_id uuid,
  sort_order integer DEFAULT 0,
  added_at timestamp with time zone DEFAULT now(),
  CONSTRAINT album_photos_pkey PRIMARY KEY (id),
  CONSTRAINT album_photos_album_id_fkey FOREIGN KEY (album_id) REFERENCES public.photo_albums(id),
  CONSTRAINT album_photos_photo_id_fkey FOREIGN KEY (photo_id) REFERENCES public.project_photos(id)
);
CREATE TABLE public.approval_requests (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid,
  document_id uuid,
  request_type character varying NOT NULL CHECK (request_type::text = ANY (ARRAY['change_order'::character varying, 'payment_approval'::character varying, 'material_selection'::character varying, 'plan_approval'::character varying, 'timeline_change'::character varying, 'budget_change'::character varying, 'contractor_change'::character varying, 'scope_change'::character varying]::text[])),
  title character varying NOT NULL,
  description text NOT NULL,
  requested_by uuid,
  assigned_to uuid,
  priority_level character varying DEFAULT 'normal'::character varying CHECK (priority_level::text = ANY (ARRAY['low'::character varying, 'normal'::character varying, 'high'::character varying, 'urgent'::character varying]::text[])),
  status character varying DEFAULT 'pending'::character varying CHECK (status::text = ANY (ARRAY['pending'::character varying, 'in_review'::character varying, 'approved'::character varying, 'rejected'::character varying, 'revision_required'::character varying, 'cancelled'::character varying]::text[])),
  due_date date,
  estimated_cost_impact numeric,
  estimated_time_impact integer,
  supporting_documents ARRAY DEFAULT ARRAY[]::text[],
  approval_workflow jsonb DEFAULT '{}'::jsonb,
  comments text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT approval_requests_pkey PRIMARY KEY (id),
  CONSTRAINT approval_requests_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id),
  CONSTRAINT approval_requests_requested_by_fkey FOREIGN KEY (requested_by) REFERENCES public.users(id),
  CONSTRAINT approval_requests_document_id_fkey FOREIGN KEY (document_id) REFERENCES public.documents(id),
  CONSTRAINT approval_requests_assigned_to_fkey FOREIGN KEY (assigned_to) REFERENCES public.users(id)
);
CREATE TABLE public.approval_responses (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  approval_request_id uuid,
  responder_id uuid,
  decision character varying NOT NULL CHECK (decision::text = ANY (ARRAY['approved'::character varying, 'rejected'::character varying, 'revision_required'::character varying]::text[])),
  comments text,
  conditions text,
  digital_signature jsonb,
  response_date timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT approval_responses_pkey PRIMARY KEY (id),
  CONSTRAINT approval_responses_responder_id_fkey FOREIGN KEY (responder_id) REFERENCES public.users(id),
  CONSTRAINT approval_responses_approval_request_id_fkey FOREIGN KEY (approval_request_id) REFERENCES public.approval_requests(id)
);
CREATE TABLE public.approvals (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid,
  title character varying NOT NULL,
  description text,
  document_urls ARRAY,
  status character varying DEFAULT 'pending'::character varying CHECK (status::text = ANY (ARRAY['pending'::character varying, 'approved'::character varying, 'rejected'::character varying, 'revision_required'::character varying]::text[])),
  submitted_date date NOT NULL,
  response_date date,
  client_comments text,
  admin_response text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT approvals_pkey PRIMARY KEY (id)
);
CREATE TABLE public.calendar_events (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid NOT NULL,
  task_id uuid,
  event_title character varying NOT NULL,
  event_description text,
  event_type character varying NOT NULL CHECK (event_type::text = ANY (ARRAY['milestone'::character varying, 'inspection'::character varying, 'delivery'::character varying, 'meeting'::character varying, 'deadline'::character varying, 'weather_window'::character varying, 'crew_availability'::character varying, 'material_arrival'::character varying]::text[])),
  start_datetime timestamp with time zone NOT NULL,
  end_datetime timestamp with time zone NOT NULL,
  all_day boolean DEFAULT false,
  location character varying,
  attendees jsonb,
  calendar_source character varying DEFAULT 'internal'::character varying CHECK (calendar_source::text = ANY (ARRAY['internal'::character varying, 'google'::character varying, 'outlook'::character varying, 'apple'::character varying, 'external'::character varying]::text[])),
  external_event_id character varying,
  reminder_settings jsonb,
  status character varying DEFAULT 'scheduled'::character varying CHECK (status::text = ANY (ARRAY['scheduled'::character varying, 'confirmed'::character varying, 'in_progress'::character varying, 'completed'::character varying, 'cancelled'::character varying, 'rescheduled'::character varying]::text[])),
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT calendar_events_pkey PRIMARY KEY (id),
  CONSTRAINT calendar_events_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id),
  CONSTRAINT calendar_events_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id),
  CONSTRAINT calendar_events_task_id_fkey FOREIGN KEY (task_id) REFERENCES public.schedule_tasks(id)
);
CREATE TABLE public.communication_log (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid NOT NULL,
  communication_type character varying NOT NULL CHECK (communication_type::text = ANY (ARRAY['email'::character varying, 'phone'::character varying, 'meeting'::character varying, 'site_visit'::character varying, 'document_review'::character varying, 'instruction'::character varying, 'approval'::character varying]::text[])),
  subject character varying NOT NULL,
  content text,
  from_person character varying NOT NULL,
  to_person character varying NOT NULL,
  cc_persons ARRAY,
  communication_date timestamp with time zone DEFAULT now(),
  priority character varying DEFAULT 'medium'::character varying CHECK (priority::text = ANY (ARRAY['low'::character varying, 'medium'::character varying, 'high'::character varying, 'urgent'::character varying]::text[])),
  response_required boolean DEFAULT false,
  response_due_date timestamp with time zone,
  response_received boolean DEFAULT false,
  response_date timestamp with time zone,
  related_contract_id uuid,
  related_assignment_id uuid,
  attachments ARRAY,
  follow_up_required boolean DEFAULT false,
  follow_up_date timestamp with time zone,
  status character varying DEFAULT 'sent'::character varying CHECK (status::text = ANY (ARRAY['draft'::character varying, 'sent'::character varying, 'delivered'::character varying, 'read'::character varying, 'responded'::character varying, 'closed'::character varying]::text[])),
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT communication_log_pkey PRIMARY KEY (id),
  CONSTRAINT communication_log_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id),
  CONSTRAINT communication_log_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.compliance_documents (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid NOT NULL,
  uploaded_by_user_id uuid NOT NULL,
  document_name character varying NOT NULL,
  document_type character varying NOT NULL,
  document_category character varying,
  document_description text,
  regulatory_authority character varying,
  regulation_reference character varying,
  compliance_requirement text,
  document_status character varying NOT NULL DEFAULT 'active'::character varying,
  effective_date date NOT NULL,
  expiry_date date,
  renewal_required boolean DEFAULT false,
  renewal_alert_days integer DEFAULT 30,
  document_url character varying NOT NULL,
  document_size_bytes bigint,
  document_mime_type character varying,
  access_level character varying DEFAULT 'project_team'::character varying,
  last_reviewed_date date,
  next_review_date date,
  reviewed_by_user_id uuid,
  review_notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT compliance_documents_pkey PRIMARY KEY (id),
  CONSTRAINT compliance_documents_reviewed_by_user_id_fkey FOREIGN KEY (reviewed_by_user_id) REFERENCES public.users(id),
  CONSTRAINT compliance_documents_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id),
  CONSTRAINT compliance_documents_uploaded_by_user_id_fkey FOREIGN KEY (uploaded_by_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.contractor_capabilities (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  contractor_id uuid NOT NULL,
  services_offered ARRAY DEFAULT ARRAY[]::character varying[],
  specialized_skills ARRAY DEFAULT ARRAY[]::character varying[],
  equipment_owned jsonb DEFAULT '[]'::jsonb,
  vehicle_fleet jsonb DEFAULT '[]'::jsonb,
  project_types_handled ARRAY DEFAULT ARRAY[]::character varying[],
  minimum_project_size numeric,
  maximum_project_size numeric,
  safety_certifications ARRAY DEFAULT ARRAY[]::character varying[],
  technical_certifications ARRAY DEFAULT ARRAY[]::character varying[],
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT contractor_capabilities_pkey PRIMARY KEY (id),
  CONSTRAINT contractor_capabilities_contractor_id_fkey FOREIGN KEY (contractor_id) REFERENCES public.contractors(id)
);
CREATE TABLE public.contractor_reviews (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_contractor_id uuid NOT NULL,
  project_id uuid NOT NULL,
  contractor_id uuid NOT NULL,
  reviewer_id uuid NOT NULL,
  overall_rating numeric NOT NULL CHECK (overall_rating >= 1::numeric AND overall_rating <= 5::numeric),
  quality_of_work numeric NOT NULL CHECK (quality_of_work >= 1::numeric AND quality_of_work <= 5::numeric),
  timeliness numeric NOT NULL CHECK (timeliness >= 1::numeric AND timeliness <= 5::numeric),
  communication numeric NOT NULL CHECK (communication >= 1::numeric AND communication <= 5::numeric),
  cleanliness numeric NOT NULL CHECK (cleanliness >= 1::numeric AND cleanliness <= 5::numeric),
  professionalism numeric NOT NULL CHECK (professionalism >= 1::numeric AND professionalism <= 5::numeric),
  value_for_money numeric NOT NULL CHECK (value_for_money >= 1::numeric AND value_for_money <= 5::numeric),
  review_title character varying,
  review_text text,
  positive_aspects ARRAY,
  areas_for_improvement ARRAY,
  would_recommend boolean NOT NULL,
  would_hire_again boolean NOT NULL,
  before_photos ARRAY DEFAULT ARRAY[]::text[],
  after_photos ARRAY DEFAULT ARRAY[]::text[],
  review_status character varying DEFAULT 'published'::character varying CHECK (review_status::text = ANY (ARRAY['draft'::character varying, 'pending_moderation'::character varying, 'published'::character varying, 'flagged'::character varying, 'removed'::character varying]::text[])),
  is_featured boolean DEFAULT false,
  contractor_response text,
  contractor_response_date timestamp with time zone,
  review_date timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT contractor_reviews_pkey PRIMARY KEY (id),
  CONSTRAINT contractor_reviews_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id),
  CONSTRAINT contractor_reviews_project_contractor_id_fkey FOREIGN KEY (project_contractor_id) REFERENCES public.project_contractors(id),
  CONSTRAINT contractor_reviews_contractor_id_fkey FOREIGN KEY (contractor_id) REFERENCES public.contractors(id),
  CONSTRAINT contractor_reviews_reviewer_id_fkey FOREIGN KEY (reviewer_id) REFERENCES public.users(id)
);
CREATE TABLE public.contractors (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  contractor_name character varying NOT NULL,
  company_name character varying NOT NULL,
  registration_number character varying,
  primary_contact_name character varying NOT NULL,
  email character varying NOT NULL,
  phone character varying NOT NULL,
  emergency_contact character varying,
  physical_address text,
  postal_address text,
  trade_specialization character varying NOT NULL CHECK (trade_specialization::text = ANY (ARRAY['general_contractor'::character varying, 'electrical'::character varying, 'plumbing'::character varying, 'hvac'::character varying, 'roofing'::character varying, 'painting'::character varying, 'flooring'::character varying, 'tiling'::character varying, 'carpentry'::character varying, 'masonry'::character varying, 'landscaping'::character varying, 'excavation'::character varying, 'concrete'::character varying, 'steel_work'::character varying, 'glazing'::character varying, 'drywall'::character varying, 'insulation'::character varying, 'waterproofing'::character varying, 'solar'::character varying, 'security'::character varying]::text[])),
  secondary_specializations ARRAY DEFAULT ARRAY[]::character varying[],
  license_number character varying,
  license_type character varying,
  license_expiry_date date,
  certifications jsonb DEFAULT '[]'::jsonb,
  insurance_provider character varying,
  insurance_policy_number character varying,
  insurance_coverage_amount numeric,
  insurance_expiry_date date,
  liability_coverage numeric,
  years_in_business integer DEFAULT 0,
  number_of_employees integer DEFAULT 1,
  annual_turnover numeric,
  overall_rating numeric DEFAULT 0.0 CHECK (overall_rating >= 0::numeric AND overall_rating <= 5::numeric),
  quality_rating numeric DEFAULT 0.0 CHECK (quality_rating >= 0::numeric AND quality_rating <= 5::numeric),
  timeliness_rating numeric DEFAULT 0.0 CHECK (timeliness_rating >= 0::numeric AND timeliness_rating <= 5::numeric),
  communication_rating numeric DEFAULT 0.0 CHECK (communication_rating >= 0::numeric AND communication_rating <= 5::numeric),
  safety_rating numeric DEFAULT 0.0 CHECK (safety_rating >= 0::numeric AND safety_rating <= 5::numeric),
  total_projects_completed integer DEFAULT 0,
  availability_status character varying DEFAULT 'available'::character varying CHECK (availability_status::text = ANY (ARRAY['available'::character varying, 'busy'::character varying, 'unavailable'::character varying, 'seasonal'::character varying, 'retired'::character varying]::text[])),
  hourly_rate numeric,
  daily_rate numeric,
  minimum_project_value numeric,
  maximum_project_capacity integer,
  added_by_user_id uuid,
  contractor_source character varying DEFAULT 'user_added'::character varying CHECK (contractor_source::text = ANY (ARRAY['user_added'::character varying, 'korabuild_verified'::character varying, 'platform_recommended'::character varying, 'referral'::character varying]::text[])),
  verification_status character varying DEFAULT 'pending'::character varying CHECK (verification_status::text = ANY (ARRAY['pending'::character varying, 'verified'::character varying, 'rejected'::character varying, 'under_review'::character varying]::text[])),
  verified_by uuid,
  verification_date date,
  profile_photo_url text,
  company_logo_url text,
  website_url text,
  social_media_links jsonb DEFAULT '{}'::jsonb,
  portfolio_images ARRAY DEFAULT ARRAY[]::text[],
  service_areas ARRAY DEFAULT ARRAY[]::character varying[],
  travel_radius_km integer DEFAULT 50,
  payment_terms character varying DEFAULT '30 days'::character varying,
  preferred_payment_method ARRAY DEFAULT ARRAY['EFT'::character varying, 'Cash'::character varying],
  bank_details jsonb DEFAULT '{}'::jsonb,
  tax_number character varying,
  status character varying DEFAULT 'active'::character varying CHECK (status::text = ANY (ARRAY['active'::character varying, 'inactive'::character varying, 'suspended'::character varying, 'blacklisted'::character varying, 'pending_approval'::character varying]::text[])),
  blacklist_reason text,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT contractors_pkey PRIMARY KEY (id),
  CONSTRAINT contractors_verified_by_fkey FOREIGN KEY (verified_by) REFERENCES public.users(id),
  CONSTRAINT contractors_added_by_user_id_fkey FOREIGN KEY (added_by_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.conversations (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid,
  conversation_name character varying NOT NULL,
  conversation_type character varying NOT NULL DEFAULT 'project_general'::character varying CHECK (conversation_type::text = ANY (ARRAY['project_general'::character varying, 'milestone_specific'::character varying, 'client_contractor'::character varying, 'team_internal'::character varying, 'approval_workflow'::character varying, 'emergency'::character varying, 'daily_standup'::character varying, 'inspection'::character varying]::text[])),
  description text,
  is_private boolean DEFAULT false,
  participants ARRAY DEFAULT ARRAY[]::uuid[],
  created_by uuid,
  last_message_at timestamp with time zone DEFAULT now(),
  message_count integer DEFAULT 0,
  is_archived boolean DEFAULT false,
  priority_level character varying DEFAULT 'normal'::character varying CHECK (priority_level::text = ANY (ARRAY['low'::character varying, 'normal'::character varying, 'high'::character varying, 'urgent'::character varying]::text[])),
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT conversations_pkey PRIMARY KEY (id),
  CONSTRAINT conversations_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id),
  CONSTRAINT conversations_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id)
);
CREATE TABLE public.credit_accounts (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid UNIQUE,
  credit_limit numeric NOT NULL DEFAULT 0,
  used_credit numeric NOT NULL DEFAULT 0,
  available_credit numeric DEFAULT (credit_limit - used_credit),
  terms text,
  interest_rate numeric DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT credit_accounts_pkey PRIMARY KEY (id)
);
CREATE TABLE public.crew_members (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid NOT NULL,
  crew_name character varying NOT NULL,
  crew_type character varying NOT NULL CHECK (crew_type::text = ANY (ARRAY['general_construction'::character varying, 'electrical'::character varying, 'plumbing'::character varying, 'hvac'::character varying, 'roofing'::character varying, 'flooring'::character varying, 'painting'::character varying, 'landscaping'::character varying, 'inspection'::character varying, 'cleanup'::character varying]::text[])),
  crew_lead_name character varying,
  crew_lead_phone character varying,
  crew_lead_email character varying,
  crew_size integer DEFAULT 1,
  hourly_rate numeric,
  availability jsonb,
  skills jsonb,
  equipment jsonb,
  status character varying DEFAULT 'available'::character varying CHECK (status::text = ANY (ARRAY['available'::character varying, 'assigned'::character varying, 'on_site'::character varying, 'off_duty'::character varying, 'unavailable'::character varying]::text[])),
  performance_rating numeric CHECK (performance_rating >= 1.0 AND performance_rating <= 5.0),
  safety_record text,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT crew_members_pkey PRIMARY KEY (id),
  CONSTRAINT crew_members_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id)
);
CREATE TABLE public.deliveries (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  order_id uuid NOT NULL,
  delivery_number character varying NOT NULL UNIQUE,
  delivery_date date NOT NULL,
  scheduled_time time without time zone,
  actual_arrival_time timestamp with time zone,
  actual_departure_time timestamp with time zone,
  delivery_status character varying DEFAULT 'scheduled'::character varying CHECK (delivery_status::text = ANY (ARRAY['scheduled'::character varying, 'in_transit'::character varying, 'arrived'::character varying, 'unloading'::character varying, 'completed'::character varying, 'failed'::character varying, 'cancelled'::character varying, 'rescheduled'::character varying]::text[])),
  delivery_method character varying,
  vehicle_info character varying,
  driver_name character varying,
  driver_phone character varying,
  received_by uuid,
  received_by_name character varying,
  receiving_condition character varying DEFAULT 'good'::character varying CHECK (receiving_condition::text = ANY (ARRAY['excellent'::character varying, 'good'::character varying, 'fair'::character varying, 'poor'::character varying, 'damaged'::character varying]::text[])),
  delivery_photos ARRAY,
  proof_of_delivery_url character varying,
  delivery_receipt_url character varying,
  temperature_controlled boolean DEFAULT false,
  special_handling_notes text,
  discrepancies text,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT deliveries_pkey PRIMARY KEY (id),
  CONSTRAINT deliveries_received_by_fkey FOREIGN KEY (received_by) REFERENCES public.users(id),
  CONSTRAINT deliveries_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.project_orders(id)
);
CREATE TABLE public.delivery_items (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  delivery_id uuid NOT NULL,
  order_item_id uuid NOT NULL,
  quantity_delivered numeric NOT NULL CHECK (quantity_delivered >= 0::numeric),
  quantity_accepted numeric DEFAULT 0.00,
  quantity_rejected numeric DEFAULT 0.00,
  condition_on_arrival character varying DEFAULT 'good'::character varying CHECK (condition_on_arrival::text = ANY (ARRAY['excellent'::character varying, 'good'::character varying, 'fair'::character varying, 'poor'::character varying, 'damaged'::character varying]::text[])),
  rejection_reason character varying,
  storage_location character varying,
  lot_number character varying,
  expiry_date date,
  quality_check_passed boolean DEFAULT true,
  quality_notes text,
  photos ARRAY,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT delivery_items_pkey PRIMARY KEY (id),
  CONSTRAINT delivery_items_delivery_id_fkey FOREIGN KEY (delivery_id) REFERENCES public.deliveries(id),
  CONSTRAINT delivery_items_order_item_id_fkey FOREIGN KEY (order_item_id) REFERENCES public.order_items(id)
);
CREATE TABLE public.document_versions (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  document_id uuid,
  version_number numeric NOT NULL,
  file_url text NOT NULL,
  file_size_bytes integer,
  change_description text,
  uploaded_by uuid,
  is_current boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT document_versions_pkey PRIMARY KEY (id),
  CONSTRAINT document_versions_document_id_fkey FOREIGN KEY (document_id) REFERENCES public.documents(id),
  CONSTRAINT document_versions_uploaded_by_fkey FOREIGN KEY (uploaded_by) REFERENCES public.users(id)
);
CREATE TABLE public.documents (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid,
  document_name character varying NOT NULL,
  document_type character varying NOT NULL CHECK (document_type::text = ANY (ARRAY['contract'::character varying, 'plan'::character varying, 'permit'::character varying, 'invoice'::character varying, 'receipt'::character varying, 'report'::character varying, 'specification'::character varying, 'change_order'::character varying, 'inspection'::character varying, 'certificate'::character varying, 'warranty'::character varying, 'manual'::character varying, 'photo'::character varying, 'other'::character varying]::text[])),
  category character varying NOT NULL DEFAULT 'general'::character varying,
  file_url text NOT NULL,
  file_size_bytes integer,
  file_type character varying,
  version_number numeric DEFAULT 1.0,
  is_current_version boolean DEFAULT true,
  description text,
  tags ARRAY DEFAULT ARRAY[]::text[],
  uploaded_by uuid,
  approved_by uuid,
  approval_status character varying DEFAULT 'pending'::character varying CHECK (approval_status::text = ANY (ARRAY['pending'::character varying, 'approved'::character varying, 'rejected'::character varying, 'revision_required'::character varying, 'archived'::character varying]::text[])),
  approval_date timestamp with time zone,
  is_public boolean DEFAULT false,
  download_count integer DEFAULT 0,
  last_viewed_at timestamp with time zone,
  expiry_date date,
  checksum character varying,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT documents_pkey PRIMARY KEY (id),
  CONSTRAINT documents_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id),
  CONSTRAINT documents_uploaded_by_fkey FOREIGN KEY (uploaded_by) REFERENCES public.users(id),
  CONSTRAINT documents_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.users(id)
);
CREATE TABLE public.emergency_contacts (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid NOT NULL,
  contact_name character varying NOT NULL,
  contact_title character varying,
  organization character varying,
  contact_type character varying NOT NULL,
  contact_priority integer NOT NULL DEFAULT 1,
  primary_phone character varying NOT NULL,
  secondary_phone character varying,
  email character varying,
  address text,
  response_time_minutes integer,
  services_provided ARRAY,
  available_24_7 boolean DEFAULT false,
  availability_hours character varying,
  coverage_area character varying,
  emergency_protocols text,
  escalation_procedure text,
  special_instructions text,
  is_active boolean DEFAULT true,
  last_verified_date date,
  verification_frequency_days integer DEFAULT 90,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT emergency_contacts_pkey PRIMARY KEY (id),
  CONSTRAINT emergency_contacts_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id)
);
CREATE TABLE public.enhanced_credit_accounts (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid,
  client_id uuid,
  credit_limit numeric NOT NULL DEFAULT 0,
  used_credit numeric NOT NULL DEFAULT 0,
  available_credit numeric DEFAULT (credit_limit - used_credit),
  interest_rate numeric NOT NULL DEFAULT 0,
  credit_terms text NOT NULL DEFAULT '30 days net'::text,
  credit_status text DEFAULT 'pending'::text CHECK (credit_status = ANY (ARRAY['active'::text, 'suspended'::text, 'closed'::text, 'pending'::text])),
  monthly_payment numeric NOT NULL DEFAULT 0,
  next_payment_date date,
  last_payment_date date,
  credit_score integer CHECK (credit_score >= 300 AND credit_score <= 850),
  approval_date date NOT NULL DEFAULT CURRENT_DATE,
  expiry_date date NOT NULL DEFAULT (CURRENT_DATE + '1 year'::interval),
  notes text,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT enhanced_credit_accounts_pkey PRIMARY KEY (id),
  CONSTRAINT enhanced_credit_accounts_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.users(id),
  CONSTRAINT enhanced_credit_accounts_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id),
  CONSTRAINT enhanced_credit_accounts_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.financial_budgets (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid,
  milestone_id uuid,
  category_id uuid,
  budget_name character varying NOT NULL,
  budgeted_amount numeric NOT NULL DEFAULT 0,
  actual_amount numeric NOT NULL DEFAULT 0,
  variance_amount numeric DEFAULT (actual_amount - budgeted_amount),
  variance_percentage numeric DEFAULT 
CASE
    WHEN (budgeted_amount > (0)::numeric) THEN (((actual_amount - budgeted_amount) / budgeted_amount) * (100)::numeric)
    ELSE (0)::numeric
END,
  budget_period text DEFAULT 'milestone'::text CHECK (budget_period = ANY (ARRAY['monthly'::text, 'quarterly'::text, 'milestone'::text, 'project'::text])),
  start_date date,
  end_date date,
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'completed'::text, 'exceeded'::text, 'cancelled'::text])),
  notes text,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT financial_budgets_pkey PRIMARY KEY (id),
  CONSTRAINT financial_budgets_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id),
  CONSTRAINT financial_budgets_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id),
  CONSTRAINT financial_budgets_milestone_id_fkey FOREIGN KEY (milestone_id) REFERENCES public.project_milestones(id),
  CONSTRAINT financial_budgets_category_id_fkey FOREIGN KEY (category_id) REFERENCES public.payment_categories(id)
);
CREATE TABLE public.firebase_users (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  firebase_uid text NOT NULL UNIQUE,
  email text NOT NULL,
  full_name text,
  phone text,
  role text DEFAULT 'client'::text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT firebase_users_pkey PRIMARY KEY (id)
);
CREATE TABLE public.inventory_items (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  item_code character varying NOT NULL UNIQUE,
  item_name character varying NOT NULL,
  description text,
  category character varying NOT NULL,
  subcategory character varying,
  unit_of_measure character varying NOT NULL,
  current_stock numeric DEFAULT 0.00,
  min_stock_level numeric DEFAULT 0.00,
  max_stock_level numeric,
  reorder_point numeric,
  standard_cost numeric,
  last_cost numeric,
  average_cost numeric,
  supplier_id uuid,
  supplier_item_code character varying,
  lead_time_days integer DEFAULT 0,
  is_active boolean DEFAULT true,
  weight_per_unit numeric,
  dimensions jsonb,
  storage_location character varying,
  safety_notes text,
  material_specs jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT inventory_items_pkey PRIMARY KEY (id),
  CONSTRAINT inventory_items_supplier_id_fkey FOREIGN KEY (supplier_id) REFERENCES public.suppliers(id)
);
CREATE TABLE public.inventory_transactions (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid,
  inventory_item_id uuid NOT NULL,
  transaction_type character varying NOT NULL CHECK (transaction_type::text = ANY (ARRAY['receipt'::character varying, 'issue'::character varying, 'adjustment'::character varying, 'transfer'::character varying, 'return'::character varying, 'waste'::character varying, 'theft'::character varying]::text[])),
  transaction_date timestamp with time zone DEFAULT now(),
  quantity numeric NOT NULL,
  unit_cost numeric,
  total_value numeric,
  reference_type character varying,
  reference_id uuid,
  from_location character varying,
  to_location character varying,
  performed_by uuid,
  reason character varying,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT inventory_transactions_pkey PRIMARY KEY (id),
  CONSTRAINT inventory_transactions_performed_by_fkey FOREIGN KEY (performed_by) REFERENCES public.users(id),
  CONSTRAINT inventory_transactions_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id),
  CONSTRAINT inventory_transactions_inventory_item_id_fkey FOREIGN KEY (inventory_item_id) REFERENCES public.inventory_items(id)
);
CREATE TABLE public.legacy_orders (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid,
  order_number character varying NOT NULL UNIQUE,
  description text NOT NULL,
  total_amount numeric NOT NULL,
  status character varying DEFAULT 'pending'::character varying CHECK (status::text = ANY (ARRAY['pending'::character varying, 'confirmed'::character varying, 'shipped'::character varying, 'delivered'::character varying, 'cancelled'::character varying]::text[])),
  order_date date NOT NULL,
  expected_delivery date,
  actual_delivery date,
  supplier character varying NOT NULL,
  supplier_contact text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT legacy_orders_pkey PRIMARY KEY (id)
);
CREATE TABLE public.meeting_records (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid NOT NULL,
  meeting_type character varying NOT NULL CHECK (meeting_type::text = ANY (ARRAY['project_kickoff'::character varying, 'progress_review'::character varying, 'safety_briefing'::character varying, 'coordination'::character varying, 'client_meeting'::character varying, 'emergency'::character varying]::text[])),
  meeting_title character varying NOT NULL,
  meeting_date timestamp with time zone NOT NULL,
  duration_minutes integer,
  location character varying,
  meeting_organizer uuid,
  attendees jsonb,
  agenda ARRAY,
  minutes text,
  action_items jsonb,
  decisions_made ARRAY,
  next_meeting_date timestamp with time zone,
  meeting_documents ARRAY,
  recording_url text,
  status character varying DEFAULT 'scheduled'::character varying CHECK (status::text = ANY (ARRAY['scheduled'::character varying, 'completed'::character varying, 'cancelled'::character varying, 'postponed'::character varying]::text[])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT meeting_records_pkey PRIMARY KEY (id),
  CONSTRAINT meeting_records_meeting_organizer_fkey FOREIGN KEY (meeting_organizer) REFERENCES public.users(id),
  CONSTRAINT meeting_records_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id)
);
CREATE TABLE public.messages (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  conversation_id uuid,
  sender_id uuid,
  message_text text,
  message_type character varying DEFAULT 'text'::character varying CHECK (message_type::text = ANY (ARRAY['text'::character varying, 'file'::character varying, 'image'::character varying, 'document'::character varying, 'location'::character varying, 'voice'::character varying, 'system'::character varying, 'approval_request'::character varying]::text[])),
  attachment_urls ARRAY DEFAULT ARRAY[]::text[],
  reply_to_id uuid,
  is_edited boolean DEFAULT false,
  edited_at timestamp with time zone,
  is_pinned boolean DEFAULT false,
  read_by jsonb DEFAULT '{}'::jsonb,
  reactions jsonb DEFAULT '{}'::jsonb,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT messages_pkey PRIMARY KEY (id),
  CONSTRAINT messages_sender_id_fkey FOREIGN KEY (sender_id) REFERENCES public.users(id),
  CONSTRAINT messages_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.conversations(id),
  CONSTRAINT messages_reply_to_id_fkey FOREIGN KEY (reply_to_id) REFERENCES public.messages(id)
);
CREATE TABLE public.notification_preferences (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  notification_type character varying NOT NULL,
  push_enabled boolean DEFAULT true,
  email_enabled boolean DEFAULT true,
  sms_enabled boolean DEFAULT false,
  in_app_enabled boolean DEFAULT true,
  quiet_hours_start time without time zone,
  quiet_hours_end time without time zone,
  weekend_enabled boolean DEFAULT false,
  frequency character varying DEFAULT 'immediate'::character varying CHECK (frequency::text = ANY (ARRAY['immediate'::character varying, 'hourly'::character varying, 'daily'::character varying, 'weekly'::character varying]::text[])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT notification_preferences_pkey PRIMARY KEY (id),
  CONSTRAINT notification_preferences_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.notifications (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  project_id uuid,
  notification_type character varying NOT NULL CHECK (notification_type::text = ANY (ARRAY['message'::character varying, 'document_upload'::character varying, 'approval_request'::character varying, 'approval_response'::character varying, 'payment'::character varying, 'milestone_update'::character varying, 'deadline_reminder'::character varying, 'system'::character varying, 'emergency'::character varying, 'inspection'::character varying]::text[])),
  title character varying NOT NULL,
  message text NOT NULL,
  entity_id uuid,
  entity_type character varying,
  priority_level character varying DEFAULT 'normal'::character varying CHECK (priority_level::text = ANY (ARRAY['low'::character varying, 'normal'::character varying, 'high'::character varying, 'urgent'::character varying]::text[])),
  is_read boolean DEFAULT false,
  read_at timestamp with time zone,
  action_url text,
  expires_at timestamp with time zone,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT notifications_pkey PRIMARY KEY (id),
  CONSTRAINT notifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT notifications_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id)
);
CREATE TABLE public.order_items (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  order_id uuid NOT NULL,
  inventory_item_id uuid,
  line_number integer NOT NULL,
  item_description character varying NOT NULL,
  item_code character varying,
  quantity_ordered numeric NOT NULL CHECK (quantity_ordered > 0::numeric),
  quantity_delivered numeric DEFAULT 0.00,
  quantity_remaining numeric DEFAULT (quantity_ordered - quantity_delivered),
  unit_of_measure character varying NOT NULL,
  unit_cost numeric NOT NULL CHECK (unit_cost >= 0::numeric),
  line_total numeric DEFAULT (quantity_ordered * unit_cost),
  delivery_status character varying DEFAULT 'pending'::character varying CHECK (delivery_status::text = ANY (ARRAY['pending'::character varying, 'partial'::character varying, 'complete'::character varying, 'cancelled'::character varying]::text[])),
  specifications text,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT order_items_pkey PRIMARY KEY (id),
  CONSTRAINT order_items_inventory_item_id_fkey FOREIGN KEY (inventory_item_id) REFERENCES public.inventory_items(id),
  CONSTRAINT order_items_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.project_orders(id)
);
CREATE TABLE public.order_status_history (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  order_id uuid NOT NULL,
  old_status character varying,
  new_status character varying NOT NULL,
  changed_by uuid,
  change_reason character varying,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT order_status_history_pkey PRIMARY KEY (id),
  CONSTRAINT order_status_history_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.project_orders(id),
  CONSTRAINT order_status_history_changed_by_fkey FOREIGN KEY (changed_by) REFERENCES public.users(id)
);
CREATE TABLE public.payment_categories (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  category_name character varying NOT NULL UNIQUE,
  category_code character varying NOT NULL UNIQUE,
  description text,
  icon_name character varying,
  color_hex character varying NOT NULL DEFAULT '#fe6700'::character varying,
  is_active boolean DEFAULT true,
  sort_order integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT payment_categories_pkey PRIMARY KEY (id)
);
CREATE TABLE public.payments (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid,
  milestone_id uuid,
  amount numeric NOT NULL,
  payment_date date NOT NULL,
  payment_method character varying NOT NULL,
  reference character varying NOT NULL UNIQUE,
  description text NOT NULL,
  receipt_url text,
  status character varying DEFAULT 'pending'::character varying CHECK (status::text = ANY (ARRAY['pending'::character varying, 'completed'::character varying, 'failed'::character varying, 'refunded'::character varying]::text[])),
  payment_category character varying DEFAULT 'milestone'::character varying CHECK (payment_category::text = ANY (ARRAY['milestone'::character varying, 'materials'::character varying, 'labor'::character varying, 'permits'::character varying, 'other'::character varying]::text[])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT payments_pkey PRIMARY KEY (id),
  CONSTRAINT payments_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id),
  CONSTRAINT payments_milestone_id_fkey FOREIGN KEY (milestone_id) REFERENCES public.project_milestones(id)
);
CREATE TABLE public.photo_albums (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid,
  album_name character varying NOT NULL,
  description text,
  cover_photo_id uuid,
  photo_count integer DEFAULT 0,
  is_public boolean DEFAULT false,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT photo_albums_pkey PRIMARY KEY (id),
  CONSTRAINT photo_albums_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id),
  CONSTRAINT photo_albums_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id),
  CONSTRAINT photo_albums_cover_photo_id_fkey FOREIGN KEY (cover_photo_id) REFERENCES public.project_photos(id)
);
CREATE TABLE public.photo_comments (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  photo_id uuid,
  user_id uuid,
  comment_text text NOT NULL,
  reply_to_id uuid,
  annotation_coordinates jsonb,
  is_resolved boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT photo_comments_pkey PRIMARY KEY (id),
  CONSTRAINT photo_comments_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT photo_comments_photo_id_fkey FOREIGN KEY (photo_id) REFERENCES public.project_photos(id),
  CONSTRAINT photo_comments_reply_to_id_fkey FOREIGN KEY (reply_to_id) REFERENCES public.photo_comments(id)
);
CREATE TABLE public.project_contractors (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid NOT NULL,
  contractor_id uuid NOT NULL,
  contract_number character varying UNIQUE,
  contract_type character varying DEFAULT 'service_contract'::character varying CHECK (contract_type::text = ANY (ARRAY['main_contract'::character varying, 'subcontract'::character varying, 'service_contract'::character varying, 'consultation'::character varying, 'maintenance'::character varying]::text[])),
  contract_status character varying DEFAULT 'active'::character varying CHECK (contract_status::text = ANY (ARRAY['draft'::character varying, 'pending_approval'::character varying, 'active'::character varying, 'completed'::character varying, 'terminated'::character varying, 'suspended'::character varying, 'on_hold'::character varying, 'expired'::character varying]::text[])),
  signed_date date,
  start_date date NOT NULL,
  planned_end_date date,
  actual_end_date date,
  contract_value numeric NOT NULL DEFAULT 0,
  payment_schedule character varying DEFAULT 'milestone_based'::character varying,
  payment_terms character varying DEFAULT '30 days'::character varying,
  retention_percentage numeric DEFAULT 10.0,
  retention_amount numeric DEFAULT 0,
  scope_of_work text NOT NULL,
  deliverables ARRAY DEFAULT ARRAY[]::text[],
  work_phases ARRAY DEFAULT ARRAY[]::character varying[],
  on_site_status character varying DEFAULT 'scheduled'::character varying CHECK (on_site_status::text = ANY (ARRAY['not_started'::character varying, 'scheduled'::character varying, 'on_site'::character varying, 'temporarily_off_site'::character varying, 'work_completed'::character varying, 'standby'::character varying]::text[])),
  first_day_on_site date,
  last_day_on_site date,
  estimated_days_on_site integer,
  actual_days_on_site integer DEFAULT 0,
  work_quality_rating numeric CHECK (work_quality_rating >= 0::numeric AND work_quality_rating <= 5::numeric),
  schedule_adherence_rating numeric CHECK (schedule_adherence_rating >= 0::numeric AND schedule_adherence_rating <= 5::numeric),
  communication_rating numeric CHECK (communication_rating >= 0::numeric AND communication_rating <= 5::numeric),
  safety_compliance_rating numeric CHECK (safety_compliance_rating >= 0::numeric AND safety_compliance_rating <= 5::numeric),
  contract_variations jsonb DEFAULT '[]'::jsonb,
  performance_issues jsonb DEFAULT '[]'::jsonb,
  safety_incidents integer DEFAULT 0,
  client_complaints integer DEFAULT 0,
  assigned_by uuid,
  project_manager_notes text,
  client_feedback text,
  total_paid numeric DEFAULT 0,
  amount_outstanding numeric DEFAULT 0,
  last_payment_date date,
  work_completion_percentage integer DEFAULT 0 CHECK (work_completion_percentage >= 0 AND work_completion_percentage <= 100),
  completion_certificate_url text,
  final_inspection_date date,
  warranty_period_months integer DEFAULT 12,
  warranty_expiry_date date,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT project_contractors_pkey PRIMARY KEY (id),
  CONSTRAINT project_contractors_assigned_by_fkey FOREIGN KEY (assigned_by) REFERENCES public.users(id),
  CONSTRAINT project_contractors_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id),
  CONSTRAINT project_contractors_contractor_id_fkey FOREIGN KEY (contractor_id) REFERENCES public.contractors(id)
);
CREATE TABLE public.project_financials (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid,
  milestone_id uuid,
  cash_received numeric NOT NULL DEFAULT 0.00,
  amount_used numeric NOT NULL DEFAULT 0.00,
  amount_remaining numeric NOT NULL DEFAULT 0.00,
  calculated_from_payments boolean DEFAULT true,
  snapshot_date date NOT NULL DEFAULT CURRENT_DATE,
  expense_breakdown jsonb DEFAULT '{}'::jsonb,
  notes text,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT project_financials_pkey PRIMARY KEY (id),
  CONSTRAINT project_financials_milestone_id_fkey FOREIGN KEY (milestone_id) REFERENCES public.project_milestones(id),
  CONSTRAINT project_financials_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id),
  CONSTRAINT project_financials_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.project_milestones (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid,
  milestone_name character varying NOT NULL,
  description text,
  phase_category character varying NOT NULL DEFAULT 'general'::character varying CHECK (phase_category::text = ANY (ARRAY['site_preparation'::character varying, 'foundation'::character varying, 'structure'::character varying, 'roofing'::character varying, 'electrical'::character varying, 'plumbing'::character varying, 'interior'::character varying, 'finishing'::character varying, 'landscaping'::character varying, 'permits'::character varying, 'general'::character varying]::text[])),
  planned_start date,
  planned_end date,
  actual_start date,
  actual_end date,
  status character varying DEFAULT 'not_started'::character varying CHECK (status::text = ANY (ARRAY['not_started'::character varying, 'in_progress'::character varying, 'completed'::character varying, 'delayed'::character varying, 'on_hold'::character varying]::text[])),
  progress_percentage integer DEFAULT 0 CHECK (progress_percentage >= 0 AND progress_percentage <= 100),
  photos ARRAY DEFAULT ARRAY[]::text[],
  notes text,
  order_index integer DEFAULT 0,
  estimated_cost numeric,
  actual_cost numeric,
  responsible_contractor character varying,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT project_milestones_pkey PRIMARY KEY (id),
  CONSTRAINT project_milestones_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id)
);
CREATE TABLE public.project_orders (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid NOT NULL,
  supplier_id uuid NOT NULL,
  order_number character varying NOT NULL UNIQUE,
  order_date date NOT NULL DEFAULT CURRENT_DATE,
  required_date date,
  promised_date date,
  expected_delivery_date date,
  actual_delivery_date date,
  status character varying DEFAULT 'draft'::character varying CHECK (status::text = ANY (ARRAY['draft'::character varying, 'pending_approval'::character varying, 'approved'::character varying, 'sent_to_supplier'::character varying, 'confirmed'::character varying, 'in_transit'::character varying, 'partially_delivered'::character varying, 'delivered'::character varying, 'cancelled'::character varying, 'returned'::character varying]::text[])),
  priority character varying DEFAULT 'medium'::character varying CHECK (priority::text = ANY (ARRAY['low'::character varying, 'medium'::character varying, 'high'::character varying, 'urgent'::character varying]::text[])),
  order_type character varying DEFAULT 'purchase'::character varying CHECK (order_type::text = ANY (ARRAY['purchase'::character varying, 'rental'::character varying, 'service'::character varying]::text[])),
  subtotal numeric DEFAULT 0.00,
  tax_amount numeric DEFAULT 0.00,
  shipping_cost numeric DEFAULT 0.00,
  discount_amount numeric DEFAULT 0.00,
  total_amount numeric DEFAULT 0.00,
  currency character varying DEFAULT 'ZAR'::character varying,
  payment_status character varying DEFAULT 'pending'::character varying CHECK (payment_status::text = ANY (ARRAY['pending'::character varying, 'partial'::character varying, 'paid'::character varying, 'overdue'::character varying]::text[])),
  payment_terms character varying,
  delivery_address text,
  delivery_instructions text,
  ordered_by uuid,
  approved_by uuid,
  notes text,
  terms_and_conditions text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT project_orders_pkey PRIMARY KEY (id),
  CONSTRAINT project_orders_supplier_id_fkey FOREIGN KEY (supplier_id) REFERENCES public.suppliers(id),
  CONSTRAINT project_orders_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id),
  CONSTRAINT project_orders_ordered_by_fkey FOREIGN KEY (ordered_by) REFERENCES public.users(id),
  CONSTRAINT project_orders_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.users(id)
);
CREATE TABLE public.project_photos (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid,
  milestone_id uuid,
  photo_url text NOT NULL,
  photo_title character varying,
  description text,
  phase_category character varying NOT NULL CHECK (phase_category::text = ANY (ARRAY['site_preparation'::character varying, 'foundation'::character varying, 'structure'::character varying, 'roofing'::character varying, 'electrical'::character varying, 'plumbing'::character varying, 'interior'::character varying, 'finishing'::character varying, 'landscaping'::character varying, 'permits'::character varying, 'general'::character varying]::text[])),
  photo_type character varying DEFAULT 'progress'::character varying CHECK (photo_type::text = ANY (ARRAY['progress'::character varying, 'before'::character varying, 'after'::character varying, 'issue'::character varying, 'completion'::character varying, 'quality_check'::character varying, '360_view'::character varying, 'drone'::character varying, 'timelapse'::character varying]::text[])),
  date_taken timestamp with time zone DEFAULT now(),
  uploaded_by uuid,
  gps_coordinates USER-DEFINED,
  weather_conditions character varying,
  camera_settings jsonb DEFAULT '{}'::jsonb,
  file_size_bytes integer,
  image_dimensions jsonb DEFAULT '{}'::jsonb,
  compression_ratio numeric,
  hash_checksum character varying,
  is_featured boolean DEFAULT false,
  likes_count integer DEFAULT 0,
  views_count integer DEFAULT 0,
  tags ARRAY DEFAULT ARRAY[]::text[],
  annotation_data jsonb DEFAULT '{}'::jsonb,
  processing_status character varying DEFAULT 'completed'::character varying CHECK (processing_status::text = ANY (ARRAY['uploading'::character varying, 'processing'::character varying, 'completed'::character varying, 'failed'::character varying]::text[])),
  quality_score numeric,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT project_photos_pkey PRIMARY KEY (id),
  CONSTRAINT project_photos_uploaded_by_fkey FOREIGN KEY (uploaded_by) REFERENCES public.users(id),
  CONSTRAINT project_photos_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id),
  CONSTRAINT project_photos_milestone_id_fkey FOREIGN KEY (milestone_id) REFERENCES public.project_milestones(id)
);
CREATE TABLE public.project_schedules (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid NOT NULL,
  schedule_name character varying NOT NULL,
  schedule_type character varying NOT NULL CHECK (schedule_type::text = ANY (ARRAY['baseline'::character varying, 'current'::character varying, 'revised'::character varying, 'what_if'::character varying]::text[])),
  status character varying NOT NULL DEFAULT 'active'::character varying CHECK (status::text = ANY (ARRAY['active'::character varying, 'archived'::character varying, 'draft'::character varying, 'approved'::character varying]::text[])),
  start_date date NOT NULL,
  end_date date NOT NULL,
  baseline_duration integer NOT NULL,
  current_duration integer,
  critical_path jsonb,
  schedule_health character varying DEFAULT 'on_track'::character varying CHECK (schedule_health::text = ANY (ARRAY['ahead'::character varying, 'on_track'::character varying, 'at_risk'::character varying, 'delayed'::character varying]::text[])),
  completion_percentage numeric DEFAULT 0.00 CHECK (completion_percentage >= 0::numeric AND completion_percentage <= 100::numeric),
  notes text,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT project_schedules_pkey PRIMARY KEY (id),
  CONSTRAINT project_schedules_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id),
  CONSTRAINT project_schedules_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id)
);
CREATE TABLE public.project_updates (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid,
  milestone_id uuid,
  update_type character varying NOT NULL CHECK (update_type::text = ANY (ARRAY['milestone'::character varying, 'payment'::character varying, 'delivery'::character varying, 'photo'::character varying, 'note'::character varying, 'approval'::character varying, 'weather'::character varying, 'delay'::character varying, 'completion'::character varying]::text[])),
  title character varying NOT NULL,
  description text,
  photo_urls ARRAY,
  metadata jsonb,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  photo_ids ARRAY DEFAULT ARRAY[]::uuid[],
  update_priority character varying DEFAULT 'normal'::character varying CHECK (update_priority::text = ANY (ARRAY['low'::character varying, 'normal'::character varying, 'high'::character varying, 'urgent'::character varying]::text[])),
  location USER-DEFINED,
  is_pinned boolean DEFAULT false,
  visibility character varying DEFAULT 'project'::character varying CHECK (visibility::text = ANY (ARRAY['public'::character varying, 'project'::character varying, 'milestone'::character varying, 'private'::character varying]::text[])),
  CONSTRAINT project_updates_pkey PRIMARY KEY (id),
  CONSTRAINT project_updates_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id),
  CONSTRAINT project_updates_milestone_id_fkey FOREIGN KEY (milestone_id) REFERENCES public.project_milestones(id),
  CONSTRAINT project_updates_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id)
);
CREATE TABLE public.projects (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  client_id uuid,
  project_name character varying NOT NULL,
  project_address text NOT NULL,
  contract_value numeric NOT NULL,
  start_date date NOT NULL,
  expected_completion date NOT NULL,
  actual_completion date,
  current_phase character varying DEFAULT 'Planning'::character varying,
  progress_percentage integer DEFAULT 0 CHECK (progress_percentage >= 0 AND progress_percentage <= 100),
  status character varying DEFAULT 'planning'::character varying CHECK (status::text = ANY (ARRAY['planning'::character varying, 'in_progress'::character varying, 'completed'::character varying, 'on_hold'::character varying, 'cancelled'::character varying]::text[])),
  description text,
  project_photo_urls ARRAY,
  weather_location character varying,
  site_coordinates USER-DEFINED,
  total_milestones integer DEFAULT 0,
  completed_milestones integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT projects_pkey PRIMARY KEY (id),
  CONSTRAINT projects_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.users(id)
);
CREATE TABLE public.quality_checklist_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  checklist_id uuid,
  item_order integer NOT NULL,
  item_description text NOT NULL,
  item_category character varying,
  is_critical boolean DEFAULT false,
  expected_outcome text,
  measurement_unit character varying,
  acceptable_range character varying,
  testing_method text,
  reference_standard character varying,
  photo_required boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT quality_checklist_items_pkey PRIMARY KEY (id),
  CONSTRAINT quality_checklist_items_checklist_id_fkey FOREIGN KEY (checklist_id) REFERENCES public.quality_checklists(id)
);
CREATE TABLE public.quality_checklists (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  inspection_type character varying NOT NULL,
  checklist_name character varying NOT NULL,
  checklist_version character varying DEFAULT '1.0'::character varying,
  is_active boolean DEFAULT true,
  industry_standard character varying,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT quality_checklists_pkey PRIMARY KEY (id),
  CONSTRAINT quality_checklists_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.quality_inspection_results (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  inspection_id uuid,
  checklist_item_id uuid,
  result_status character varying CHECK (result_status::text = ANY (ARRAY['pass'::character varying, 'fail'::character varying, 'na'::character varying, 'conditional'::character varying]::text[])),
  measured_value character varying,
  actual_outcome text,
  deficiency_description text,
  corrective_action_required text,
  corrective_action_deadline date,
  inspector_comments text,
  photo_urls ARRAY,
  gps_coordinates point,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT quality_inspection_results_pkey PRIMARY KEY (id),
  CONSTRAINT quality_inspection_results_inspection_id_fkey FOREIGN KEY (inspection_id) REFERENCES public.quality_inspections(id),
  CONSTRAINT quality_inspection_results_checklist_item_id_fkey FOREIGN KEY (checklist_item_id) REFERENCES public.quality_checklist_items(id)
);
CREATE TABLE public.quality_inspections (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  project_id uuid,
  inspector_id uuid,
  milestone_id uuid,
  inspection_type character varying NOT NULL CHECK (inspection_type::text = ANY (ARRAY['foundation'::character varying, 'framing'::character varying, 'electrical'::character varying, 'plumbing'::character varying, 'roofing'::character varying, 'drywall'::character varying, 'flooring'::character varying, 'final'::character varying]::text[])),
  inspection_date date NOT NULL,
  inspection_status character varying DEFAULT 'scheduled'::character varying CHECK (inspection_status::text = ANY (ARRAY['scheduled'::character varying, 'in_progress'::character varying, 'completed'::character varying, 'failed'::character varying, 'cancelled'::character varying]::text[])),
  overall_score integer CHECK (overall_score >= 0 AND overall_score <= 100),
  pass_fail_status character varying CHECK (pass_fail_status::text = ANY (ARRAY['pass'::character varying, 'fail'::character varying, 'conditional'::character varying]::text[])),
  inspector_notes text,
  client_visible boolean DEFAULT true,
  weather_conditions character varying,
  temperature_fahrenheit integer,
  inspection_duration_minutes integer,
  follow_up_required boolean DEFAULT false,
  follow_up_date date,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT quality_inspections_pkey PRIMARY KEY (id),
  CONSTRAINT quality_inspections_milestone_id_fkey FOREIGN KEY (milestone_id) REFERENCES public.project_milestones(id),
  CONSTRAINT quality_inspections_inspector_id_fkey FOREIGN KEY (inspector_id) REFERENCES public.users(id),
  CONSTRAINT quality_inspections_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id)
);
CREATE TABLE public.quality_photos (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  inspection_id uuid,
  inspection_result_id uuid,
  photo_url character varying NOT NULL,
  photo_title character varying,
  photo_description text,
  photo_type character varying CHECK (photo_type::text = ANY (ARRAY['before'::character varying, 'during'::character varying, 'after'::character varying, 'defect'::character varying, 'compliance'::character varying, 'reference'::character varying]::text[])),
  gps_coordinates point,
  compass_direction integer CHECK (compass_direction >= 0 AND compass_direction <= 360),
  altitude_meters numeric,
  camera_settings jsonb,
  weather_conditions character varying,
  lighting_conditions character varying CHECK (lighting_conditions::text = ANY (ARRAY['natural'::character varying, 'artificial'::character varying, 'flash'::character varying, 'mixed'::character varying]::text[])),
  is_annotated boolean DEFAULT false,
  annotation_data jsonb,
  photo_quality_score integer CHECK (photo_quality_score >= 1 AND photo_quality_score <= 10),
  uploader_id uuid,
  upload_device_info jsonb,
  file_size_bytes bigint,
  image_dimensions character varying,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT quality_photos_pkey PRIMARY KEY (id),
  CONSTRAINT quality_photos_inspection_id_fkey FOREIGN KEY (inspection_id) REFERENCES public.quality_inspections(id),
  CONSTRAINT quality_photos_uploader_id_fkey FOREIGN KEY (uploader_id) REFERENCES public.users(id),
  CONSTRAINT quality_photos_inspection_result_id_fkey FOREIGN KEY (inspection_result_id) REFERENCES public.quality_inspection_results(id)
);
CREATE TABLE public.quality_reports (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  project_id uuid,
  inspection_id uuid,
  report_type character varying CHECK (report_type::text = ANY (ARRAY['daily'::character varying, 'weekly'::character varying, 'milestone'::character varying, 'final'::character varying, 'corrective_action'::character varying]::text[])),
  report_period_start date,
  report_period_end date,
  overall_quality_score integer CHECK (overall_quality_score >= 0 AND overall_quality_score <= 100),
  total_inspections integer DEFAULT 0,
  passed_inspections integer DEFAULT 0,
  failed_inspections integer DEFAULT 0,
  critical_issues_count integer DEFAULT 0,
  non_critical_issues_count integer DEFAULT 0,
  corrective_actions_required integer DEFAULT 0,
  corrective_actions_completed integer DEFAULT 0,
  quality_trend character varying CHECK (quality_trend::text = ANY (ARRAY['improving'::character varying, 'stable'::character varying, 'declining'::character varying]::text[])),
  key_findings text,
  recommendations text,
  generated_by uuid,
  client_reviewed boolean DEFAULT false,
  client_review_date timestamp with time zone,
  client_comments text,
  report_pdf_url character varying,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT quality_reports_pkey PRIMARY KEY (id),
  CONSTRAINT quality_reports_generated_by_fkey FOREIGN KEY (generated_by) REFERENCES public.users(id),
  CONSTRAINT quality_reports_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id),
  CONSTRAINT quality_reports_inspection_id_fkey FOREIGN KEY (inspection_id) REFERENCES public.quality_inspections(id)
);
CREATE TABLE public.quality_standards (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  standard_code character varying NOT NULL UNIQUE,
  standard_name character varying NOT NULL,
  standard_category character varying NOT NULL,
  industry_reference character varying,
  description text,
  measurement_criteria text,
  acceptable_tolerance character varying,
  testing_frequency character varying,
  equipment_required text,
  safety_requirements text,
  documentation_required text,
  is_active boolean DEFAULT true,
  revision_number character varying DEFAULT '1.0'::character varying,
  effective_date date DEFAULT CURRENT_DATE,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT quality_standards_pkey PRIMARY KEY (id)
);
CREATE TABLE public.receipt_metadata (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  payment_id uuid,
  file_name character varying NOT NULL,
  file_path text NOT NULL,
  file_size_bytes bigint,
  file_type character varying,
  upload_date timestamp with time zone DEFAULT now(),
  processing_status text DEFAULT 'pending'::text CHECK (processing_status = ANY (ARRAY['pending'::text, 'processing'::text, 'completed'::text, 'failed'::text])),
  ocr_data jsonb DEFAULT '{}'::jsonb,
  thumbnail_url text,
  page_count integer DEFAULT 1,
  extracted_amount numeric,
  extracted_date date,
  extracted_vendor character varying,
  confidence_score numeric CHECK (confidence_score >= 0::numeric AND confidence_score <= 100::numeric),
  manual_verification boolean DEFAULT false,
  uploaded_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT receipt_metadata_pkey PRIMARY KEY (id),
  CONSTRAINT receipt_metadata_payment_id_fkey FOREIGN KEY (payment_id) REFERENCES public.payments(id),
  CONSTRAINT receipt_metadata_uploaded_by_fkey FOREIGN KEY (uploaded_by) REFERENCES public.users(id)
);
CREATE TABLE public.requests (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid,
  client_id uuid,
  request_type character varying NOT NULL CHECK (request_type::text = ANY (ARRAY['change_order'::character varying, 'inspection'::character varying, 'consultation'::character varying, 'maintenance'::character varying, 'other'::character varying]::text[])),
  category character varying NOT NULL,
  title character varying NOT NULL,
  description text NOT NULL,
  address text,
  plan_urls ARRAY,
  priority character varying DEFAULT 'medium'::character varying CHECK (priority::text = ANY (ARRAY['low'::character varying, 'medium'::character varying, 'high'::character varying, 'urgent'::character varying]::text[])),
  status character varying DEFAULT 'submitted'::character varying CHECK (status::text = ANY (ARRAY['submitted'::character varying, 'reviewing'::character varying, 'approved'::character varying, 'rejected'::character varying, 'in_progress'::character varying, 'completed'::character varying]::text[])),
  submitted_date date NOT NULL,
  response_date date,
  admin_response text,
  estimated_cost numeric,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT requests_pkey PRIMARY KEY (id)
);
CREATE TABLE public.resource_assignments (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  task_id uuid NOT NULL,
  crew_member_id uuid,
  resource_type character varying NOT NULL CHECK (resource_type::text = ANY (ARRAY['labor'::character varying, 'equipment'::character varying, 'materials'::character varying, 'subcontractor'::character varying, 'inspector'::character varying]::text[])),
  resource_name character varying NOT NULL,
  quantity_required numeric NOT NULL,
  quantity_assigned numeric DEFAULT 0,
  unit_of_measure character varying NOT NULL,
  hourly_rate numeric,
  total_cost numeric,
  availability_start date,
  availability_end date,
  status character varying DEFAULT 'assigned'::character varying CHECK (status::text = ANY (ARRAY['assigned'::character varying, 'confirmed'::character varying, 'in_use'::character varying, 'completed'::character varying, 'unavailable'::character varying]::text[])),
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT resource_assignments_pkey PRIMARY KEY (id),
  CONSTRAINT resource_assignments_task_id_fkey FOREIGN KEY (task_id) REFERENCES public.schedule_tasks(id),
  CONSTRAINT resource_assignments_crew_member_id_fkey FOREIGN KEY (crew_member_id) REFERENCES public.crew_members(id)
);
CREATE TABLE public.safety_checklists (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  checklist_name character varying NOT NULL,
  checklist_description text,
  checklist_category character varying NOT NULL,
  checklist_type character varying NOT NULL,
  osha_standard_reference character varying,
  checklist_items jsonb NOT NULL,
  required_for_phases ARRAY,
  minimum_frequency_days integer DEFAULT 1,
  is_mandatory boolean DEFAULT true,
  is_active boolean DEFAULT true,
  passing_score_threshold integer DEFAULT 80,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT safety_checklists_pkey PRIMARY KEY (id)
);
CREATE TABLE public.safety_incident_attachments (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  incident_id uuid NOT NULL,
  uploaded_by_user_id uuid NOT NULL,
  file_name character varying NOT NULL,
  file_type character varying NOT NULL,
  file_category character varying,
  file_description text,
  file_url character varying NOT NULL,
  file_size_bytes bigint,
  mime_type character varying,
  captured_at timestamp with time zone,
  gps_coordinates USER-DEFINED,
  camera_metadata jsonb,
  contains_personal_info boolean DEFAULT false,
  privacy_level character varying DEFAULT 'restricted'::character varying,
  legal_hold boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT safety_incident_attachments_pkey PRIMARY KEY (id),
  CONSTRAINT safety_incident_attachments_uploaded_by_user_id_fkey FOREIGN KEY (uploaded_by_user_id) REFERENCES public.users(id),
  CONSTRAINT safety_incident_attachments_incident_id_fkey FOREIGN KEY (incident_id) REFERENCES public.safety_incidents(id)
);
CREATE TABLE public.safety_incidents (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid NOT NULL,
  reported_by_user_id uuid NOT NULL,
  incident_date date NOT NULL,
  incident_time time with time zone NOT NULL,
  incident_location character varying NOT NULL,
  gps_coordinates USER-DEFINED,
  incident_type character varying NOT NULL,
  incident_severity character varying NOT NULL,
  incident_category character varying,
  people_involved jsonb NOT NULL,
  injured_person_count integer DEFAULT 0,
  witness_count integer DEFAULT 0,
  incident_description text NOT NULL,
  immediate_cause text,
  root_cause_analysis text,
  contributing_factors ARRAY,
  investigation_required boolean DEFAULT true,
  investigation_date date,
  investigation_status character varying DEFAULT 'pending'::character varying,
  investigator_user_id uuid,
  investigation_findings text,
  investigation_report_url character varying,
  osha_reportable boolean DEFAULT false,
  osha_report_date date,
  osha_case_number character varying,
  regulatory_notifications jsonb,
  immediate_actions_taken text,
  corrective_actions_planned jsonb,
  preventive_measures text,
  corrective_actions_completed boolean DEFAULT false,
  corrective_actions_completion_date date,
  status character varying NOT NULL DEFAULT 'open'::character varying,
  closure_date date,
  closure_notes text,
  lessons_learned text,
  photo_urls ARRAY,
  document_urls ARRAY,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT safety_incidents_pkey PRIMARY KEY (id),
  CONSTRAINT safety_incidents_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id),
  CONSTRAINT safety_incidents_investigator_user_id_fkey FOREIGN KEY (investigator_user_id) REFERENCES public.users(id),
  CONSTRAINT safety_incidents_reported_by_user_id_fkey FOREIGN KEY (reported_by_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.safety_inspections (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid NOT NULL,
  checklist_id uuid NOT NULL,
  inspector_user_id uuid NOT NULL,
  inspection_date date NOT NULL,
  inspection_time time with time zone DEFAULT now(),
  inspection_location character varying,
  gps_coordinates USER-DEFINED,
  inspection_status character varying NOT NULL DEFAULT 'scheduled'::character varying,
  safety_status character varying NOT NULL DEFAULT 'pending'::character varying,
  overall_safety_score integer,
  weather_conditions character varying,
  checklist_responses jsonb NOT NULL,
  identified_hazards ARRAY,
  hazard_severity_levels ARRAY,
  safety_violations jsonb,
  minor_violations_count integer DEFAULT 0,
  major_violations_count integer DEFAULT 0,
  critical_violations_count integer DEFAULT 0,
  osha_violations jsonb,
  follow_up_required boolean DEFAULT false,
  corrective_actions_required ARRAY,
  corrective_actions_assigned_to uuid,
  corrective_actions_due_date date,
  follow_up_date date,
  follow_up_notes text,
  inspection_notes text,
  inspector_signature character varying,
  supervisor_signature character varying,
  photo_urls ARRAY,
  document_urls ARRAY,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT safety_inspections_pkey PRIMARY KEY (id),
  CONSTRAINT safety_inspections_inspector_user_id_fkey FOREIGN KEY (inspector_user_id) REFERENCES public.users(id),
  CONSTRAINT safety_inspections_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id),
  CONSTRAINT safety_inspections_checklist_id_fkey FOREIGN KEY (checklist_id) REFERENCES public.safety_checklists(id),
  CONSTRAINT safety_inspections_corrective_actions_assigned_to_fkey FOREIGN KEY (corrective_actions_assigned_to) REFERENCES public.users(id)
);
CREATE TABLE public.safety_training_records (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid NOT NULL,
  trainee_user_id uuid NOT NULL,
  trainer_user_id uuid,
  training_type character varying NOT NULL,
  training_title character varying NOT NULL,
  training_description text,
  training_category character varying,
  training_date date NOT NULL,
  training_duration_hours numeric,
  training_location character varying,
  training_method character varying,
  training_status character varying NOT NULL DEFAULT 'scheduled'::character varying,
  attendance_confirmed boolean DEFAULT false,
  test_score numeric,
  passing_score_required numeric DEFAULT 70.00,
  certification_earned boolean DEFAULT false,
  training_topics ARRAY,
  training_materials_urls ARRAY,
  assessment_required boolean DEFAULT false,
  assessment_completed boolean DEFAULT false,
  practical_demonstration_required boolean DEFAULT false,
  practical_demonstration_passed boolean DEFAULT false,
  certification_valid_until date,
  refresher_training_required boolean DEFAULT false,
  refresher_due_date date,
  compliance_standard character varying,
  training_notes text,
  trainee_feedback text,
  certificate_url character varying,
  attendance_record_url character varying,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT safety_training_records_pkey PRIMARY KEY (id),
  CONSTRAINT safety_training_records_trainee_user_id_fkey FOREIGN KEY (trainee_user_id) REFERENCES public.users(id),
  CONSTRAINT safety_training_records_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id),
  CONSTRAINT safety_training_records_trainer_user_id_fkey FOREIGN KEY (trainer_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.schedule_deviations (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid NOT NULL,
  task_id uuid,
  phase_id uuid,
  deviation_type character varying NOT NULL CHECK (deviation_type::text = ANY (ARRAY['delay'::character varying, 'acceleration'::character varying, 'scope_change'::character varying, 'resource_change'::character varying, 'weather_delay'::character varying, 'material_delay'::character varying, 'approval_delay'::character varying, 'inspection_delay'::character varying, 'change_order'::character varying]::text[])),
  deviation_reason text NOT NULL,
  original_start_date date,
  new_start_date date,
  original_end_date date,
  new_end_date date,
  impact_days integer NOT NULL,
  cost_impact numeric DEFAULT 0,
  critical_path_impact boolean DEFAULT false,
  mitigation_plan text,
  status character varying DEFAULT 'identified'::character varying CHECK (status::text = ANY (ARRAY['identified'::character varying, 'approved'::character varying, 'implemented'::character varying, 'resolved'::character varying, 'cancelled'::character varying]::text[])),
  reported_by uuid,
  approved_by uuid,
  reported_date timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT schedule_deviations_pkey PRIMARY KEY (id),
  CONSTRAINT schedule_deviations_phase_id_fkey FOREIGN KEY (phase_id) REFERENCES public.schedule_phases(id),
  CONSTRAINT schedule_deviations_task_id_fkey FOREIGN KEY (task_id) REFERENCES public.schedule_tasks(id),
  CONSTRAINT schedule_deviations_reported_by_fkey FOREIGN KEY (reported_by) REFERENCES public.users(id),
  CONSTRAINT schedule_deviations_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.users(id),
  CONSTRAINT schedule_deviations_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id)
);
CREATE TABLE public.schedule_phases (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  schedule_id uuid NOT NULL,
  project_id uuid NOT NULL,
  phase_name character varying NOT NULL,
  phase_category character varying NOT NULL CHECK (phase_category::text = ANY (ARRAY['pre_construction'::character varying, 'foundation'::character varying, 'framing'::character varying, 'roofing'::character varying, 'electrical'::character varying, 'plumbing'::character varying, 'insulation'::character varying, 'drywall'::character varying, 'flooring'::character varying, 'interior_finishing'::character varying, 'exterior_finishing'::character varying, 'landscaping'::character varying, 'final_inspections'::character varying, 'cleanup'::character varying]::text[])),
  phase_order integer NOT NULL,
  planned_start_date date NOT NULL,
  planned_end_date date NOT NULL,
  actual_start_date date,
  actual_end_date date,
  duration_days integer NOT NULL,
  status character varying NOT NULL DEFAULT 'not_started'::character varying CHECK (status::text = ANY (ARRAY['not_started'::character varying, 'in_progress'::character varying, 'completed'::character varying, 'on_hold'::character varying, 'cancelled'::character varying]::text[])),
  progress_percentage numeric DEFAULT 0.00 CHECK (progress_percentage >= 0::numeric AND progress_percentage <= 100::numeric),
  budget_allocated numeric DEFAULT 0,
  budget_spent numeric DEFAULT 0,
  dependencies jsonb,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT schedule_phases_pkey PRIMARY KEY (id),
  CONSTRAINT schedule_phases_schedule_id_fkey FOREIGN KEY (schedule_id) REFERENCES public.project_schedules(id),
  CONSTRAINT schedule_phases_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id)
);
CREATE TABLE public.schedule_tasks (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  phase_id uuid NOT NULL,
  schedule_id uuid NOT NULL,
  project_id uuid NOT NULL,
  task_name character varying NOT NULL,
  task_description text,
  task_type character varying NOT NULL CHECK (task_type::text = ANY (ARRAY['milestone'::character varying, 'activity'::character varying, 'inspection'::character varying, 'delivery'::character varying, 'meeting'::character varying, 'approval'::character varying]::text[])),
  planned_start_date date NOT NULL,
  planned_end_date date NOT NULL,
  actual_start_date date,
  actual_end_date date,
  duration_hours numeric NOT NULL,
  status character varying NOT NULL DEFAULT 'not_started'::character varying CHECK (status::text = ANY (ARRAY['not_started'::character varying, 'in_progress'::character varying, 'completed'::character varying, 'on_hold'::character varying, 'cancelled'::character varying]::text[])),
  progress_percentage numeric DEFAULT 0.00 CHECK (progress_percentage >= 0::numeric AND progress_percentage <= 100::numeric),
  priority character varying DEFAULT 'medium'::character varying CHECK (priority::text = ANY (ARRAY['low'::character varying, 'medium'::character varying, 'high'::character varying, 'critical'::character varying]::text[])),
  cost_estimate numeric DEFAULT 0,
  actual_cost numeric DEFAULT 0,
  assigned_crew_id uuid,
  location_on_site character varying,
  weather_dependent boolean DEFAULT false,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT schedule_tasks_pkey PRIMARY KEY (id),
  CONSTRAINT schedule_tasks_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id),
  CONSTRAINT schedule_tasks_phase_id_fkey FOREIGN KEY (phase_id) REFERENCES public.schedule_phases(id),
  CONSTRAINT schedule_tasks_schedule_id_fkey FOREIGN KEY (schedule_id) REFERENCES public.project_schedules(id),
  CONSTRAINT schedule_tasks_assigned_crew_id_fkey FOREIGN KEY (assigned_crew_id) REFERENCES public.crew_members(id)
);
CREATE TABLE public.spatial_ref_sys (
  srid integer NOT NULL CHECK (srid > 0 AND srid <= 998999),
  auth_name character varying,
  auth_srid integer,
  srtext character varying,
  proj4text character varying,
  CONSTRAINT spatial_ref_sys_pkey PRIMARY KEY (srid)
);
CREATE TABLE public.suppliers (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  supplier_name character varying NOT NULL,
  supplier_code character varying NOT NULL UNIQUE,
  contact_person character varying,
  email character varying,
  phone character varying,
  address text,
  city character varying,
  province character varying,
  postal_code character varying,
  specialty character varying,
  supplier_type character varying DEFAULT 'material'::character varying,
  rating numeric DEFAULT 0.00 CHECK (rating >= 0::numeric AND rating <= 5::numeric),
  total_orders integer DEFAULT 0,
  on_time_delivery_rate numeric DEFAULT 0.00,
  quality_score numeric DEFAULT 0.00,
  status character varying DEFAULT 'active'::character varying CHECK (status::text = ANY (ARRAY['active'::character varying, 'inactive'::character varying, 'pending'::character varying, 'suspended'::character varying]::text[])),
  payment_terms character varying,
  credit_limit numeric,
  tax_number character varying,
  bank_details jsonb,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT suppliers_pkey PRIMARY KEY (id)
);
CREATE TABLE public.task_dependencies (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  predecessor_task_id uuid NOT NULL,
  successor_task_id uuid NOT NULL,
  dependency_type character varying NOT NULL DEFAULT 'finish_to_start'::character varying CHECK (dependency_type::text = ANY (ARRAY['finish_to_start'::character varying, 'start_to_start'::character varying, 'finish_to_finish'::character varying, 'start_to_finish'::character varying]::text[])),
  lag_days integer DEFAULT 0,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT task_dependencies_pkey PRIMARY KEY (id),
  CONSTRAINT task_dependencies_successor_task_id_fkey FOREIGN KEY (successor_task_id) REFERENCES public.schedule_tasks(id),
  CONSTRAINT task_dependencies_predecessor_task_id_fkey FOREIGN KEY (predecessor_task_id) REFERENCES public.schedule_tasks(id)
);
CREATE TABLE public.training_certifications (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL,
  certification_name character varying NOT NULL,
  certification_type character varying NOT NULL,
  issuing_organization character varying NOT NULL,
  certification_number character varying,
  issue_date date NOT NULL,
  expiry_date date,
  renewal_required boolean DEFAULT true,
  renewal_period_months integer,
  early_renewal_alert_days integer DEFAULT 60,
  certification_status character varying NOT NULL DEFAULT 'active'::character varying,
  verification_status character varying DEFAULT 'pending'::character varying,
  certificate_url character varying,
  verification_document_url character varying,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT training_certifications_pkey PRIMARY KEY (id),
  CONSTRAINT training_certifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.users (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  email character varying NOT NULL UNIQUE,
  full_name character varying NOT NULL,
  phone character varying,
  role character varying DEFAULT 'client'::character varying CHECK (role::text = ANY (ARRAY['client'::character varying, 'admin'::character varying, 'contractor'::character varying, 'inspector'::character varying]::text[])),
  profile_photo_url text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT users_pkey PRIMARY KEY (id)
);
CREATE TABLE public.weather_conditions (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid NOT NULL,
  date date NOT NULL,
  temperature_high numeric,
  temperature_low numeric,
  humidity_percentage integer CHECK (humidity_percentage >= 0 AND humidity_percentage <= 100),
  precipitation_mm numeric DEFAULT 0,
  wind_speed_kmh numeric DEFAULT 0,
  weather_description character varying,
  weather_code character varying,
  visibility_km numeric,
  work_suitability character varying DEFAULT 'suitable'::character varying CHECK (work_suitability::text = ANY (ARRAY['excellent'::character varying, 'suitable'::character varying, 'limited'::character varying, 'unsuitable'::character varying, 'dangerous'::character varying]::text[])),
  affected_tasks jsonb,
  impact_notes text,
  data_source character varying DEFAULT 'manual'::character varying CHECK (data_source::text = ANY (ARRAY['manual'::character varying, 'api'::character varying, 'sensor'::character varying]::text[])),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT weather_conditions_pkey PRIMARY KEY (id),
  CONSTRAINT weather_conditions_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id)
);
CREATE TABLE public.work_sessions (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  project_id uuid NOT NULL,
  task_id uuid NOT NULL,
  crew_member_id uuid,
  session_date date NOT NULL,
  start_time time without time zone NOT NULL,
  end_time time without time zone,
  duration_hours numeric,
  work_description text,
  progress_made text,
  issues_encountered text,
  materials_used jsonb,
  equipment_used jsonb,
  weather_conditions character varying,
  safety_incidents jsonb,
  quality_notes text,
  photos jsonb,
  gps_location USER-DEFINED,
  verified_by uuid,
  status character varying DEFAULT 'logged'::character varying CHECK (status::text = ANY (ARRAY['logged'::character varying, 'verified'::character varying, 'approved'::character varying, 'disputed'::character varying]::text[])),
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT work_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT work_sessions_task_id_fkey FOREIGN KEY (task_id) REFERENCES public.schedule_tasks(id),
  CONSTRAINT work_sessions_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id),
  CONSTRAINT work_sessions_crew_member_id_fkey FOREIGN KEY (crew_member_id) REFERENCES public.crew_members(id),
  CONSTRAINT work_sessions_verified_by_fkey FOREIGN KEY (verified_by) REFERENCES public.users(id),
  CONSTRAINT work_sessions_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);